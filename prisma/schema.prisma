generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Role {
  id          Int              @id @default(autoincrement())
  nombre      String           @unique
  descripcion String?
  createdAt   DateTime         @default(now()) @map("creado_at")
  updatedAt   DateTime         @updatedAt @map("actualizado_at")
  usuarios    Usuario[]
  permisos    RolePermission[]

  @@map("roles")
}

model Permission {
  id          Int              @id @default(autoincrement())
  codigo      String           @unique // "usuarios.crear", "usuarios.editar", "ventas.ver", etc.
  nombre      String
  descripcion String?
  modulo      String // "usuarios", "ventas", "inventario", "productos", etc.
  createdAt   DateTime         @default(now()) @map("creado_at")
  roles       RolePermission[]
  usuarios    UserPermission[]

  @@index([modulo])
  @@map("permissions")
}

model RolePermission {
  roleId       Int      @map("role_id")
  permissionId Int      @map("permission_id")
  createdAt    DateTime @default(now()) @map("creado_at")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model UserPermission {
  usuarioId    Int      @map("usuario_id")
  permissionId Int      @map("permission_id")
  createdAt    DateTime @default(now()) @map("creado_at")

  usuario    Usuario    @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([usuarioId, permissionId])
  @@map("user_permissions")
}

model Usuario {
  id                   Int                    @id @default(autoincrement())
  correo               String                 @unique
  nombre               String
  contrasenaHash       String                 @map("contrasena_hash")
  rolId                Int                    @map("rol_id")
  activo               Boolean                @default(true)
  intentosFallidos     Int                    @default(0) @map("intentos_fallidos")
  bloqueadoHasta       DateTime?              @map("bloqueado_hasta")
  ultimoAcceso         DateTime?              @map("ultimo_acceso")
  debeActualizarClave  Boolean                @default(false) @map("debe_actualizar_clave")
  createdAt            DateTime               @default(now()) @map("creado_at")
  updatedAt            DateTime               @updatedAt @map("actualizado_at")
  enviosCreados        Envio[]
  movimientos          MovimientoInventario[]
  notificaciones       Notificacion[]
  sucursalGerente      Sucursal?              @relation("GerenteSucursal")
  rol                  Role                   @relation(fields: [rolId], references: [id])
  ventas               Venta[]
  auditLogs            AuditLog[]
  permisosIndividuales UserPermission[]

  @@index([correo])
  @@index([activo])
  @@map("usuarios")
}

model Empresa {
  id            String     @id @default(cuid())
  nombre        String
  logoUrl       String?    @map("logo_url")
  datosFiscales Json?      @map("datos_fiscales")
  createdAt     DateTime   @default(now()) @map("creado_at")
  updatedAt     DateTime   @updatedAt @map("actualizado_at")
  envios        Envio[]
  sucursales    Sucursal[]

  @@map("empresas")
}

model Sucursal {
  id                 String            @id @default(cuid())
  empresaId          String            @map("empresa_id")
  codigoUnico        String            @unique @map("codigo_unico") // SUC-001, SUC-002
  nombre             String
  direccion          String?
  gerenteId          Int?              @unique @map("gerente_usuario_id")
  metaVentas         Decimal           @default(0) @map("meta_ventas") @db.Decimal(12, 2)
  createdAt          DateTime          @default(now()) @map("creado_at")
  updatedAt          DateTime          @updatedAt @map("actualizado_at")
  enviosDestino      Envio[]           @relation("EnvioDestino")
  enviosOrigen       Envio[]           @relation("EnvioOrigen")
  inventarios        Inventario[]
  empresa            Empresa           @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  gerente            Usuario?          @relation("GerenteSucursal", fields: [gerenteId], references: [id])
  ventas             Venta[]
  operacionesDiarias OperacionDiaria[]

  @@map("sucursales")
}

model Producto {
  id             String                    @id @default(cuid())
  sku            String                    @unique
  nombre         String
  descripcion    String?
  costoUnitario  Decimal                   @map("costo_unitario") @db.Decimal(12, 2)
  precioVenta    Decimal                   @map("precio_venta") @db.Decimal(12, 2)
  unidadMedida   String?                   @map("unidad_medida")
  createdAt      DateTime                  @default(now()) @map("fecha_creacion")
  updatedAt      DateTime                  @updatedAt @map("actualizado_at")
  envioItems     EnvioItem[]
  inventarios    Inventario[]
  movimientos    MovimientoInventario[]
  ventaItems     VentaItem[]
  devoluciones   Devolucion[]
  producciones   ProduccionDiaria[]
  plantillaItems PlantillaProduccionItem[]

  @@map("productos")
}

model Inventario {
  id             Int                    @id @default(autoincrement())
  sucursalId     String                 @map("sucursal_id")
  productoId     String                 @map("producto_id")
  cantidadActual Int                    @default(0) @map("cantidad_actual")
  stockMinimo    Int                    @default(0) @map("stock_minimo")
  updatedAt      DateTime               @updatedAt @map("actualizado_at")
  producto       Producto               @relation(fields: [productoId], references: [id])
  sucursal       Sucursal               @relation(fields: [sucursalId], references: [id], onDelete: Cascade)
  movimientos    MovimientoInventario[]

  @@unique([sucursalId, productoId])
  @@map("inventarios")
}

model MovimientoInventario {
  id           Int        @id @default(autoincrement())
  inventarioId Int        @map("inventario_id")
  tipo         String
  cantidad     Int
  motivo       String?
  productoId   String     @map("producto_id")
  creadorId    Int?       @map("creado_por")
  createdAt    DateTime   @default(now()) @map("creado_at")
  creador      Usuario?   @relation(fields: [creadorId], references: [id])
  inventario   Inventario @relation(fields: [inventarioId], references: [id], onDelete: Cascade)
  producto     Producto   @relation(fields: [productoId], references: [id])

  @@map("movimientos_inventario")
}

model Envio {
  id                String      @id @default(cuid())
  empresaId         String      @map("empresa_id")
  sucursalOrigenId  String      @map("sucursal_origen_id")
  sucursalDestinoId String      @map("sucursal_destino_id")
  estado            String      @default("pendiente")
  fechaPlanificada  DateTime?   @map("fecha_planificada") @db.Date
  fechaEnvio        DateTime?   @map("fecha_envio")
  fechaEntrega      DateTime?   @map("fecha_entrega")
  creadorId         Int?        @map("creado_por")
  confirmadoPor     Int?        @map("confirmado_por")
  fechaConfirmacion DateTime?   @map("fecha_confirmacion")
  observaciones     String?
  createdAt         DateTime    @default(now()) @map("creado_at")
  updatedAt         DateTime    @updatedAt @map("actualizado_at")
  items             EnvioItem[]
  creador           Usuario?    @relation(fields: [creadorId], references: [id])
  empresa           Empresa     @relation(fields: [empresaId], references: [id])
  sucursalDestino   Sucursal    @relation("EnvioDestino", fields: [sucursalDestinoId], references: [id])
  sucursalOrigen    Sucursal    @relation("EnvioOrigen", fields: [sucursalOrigenId], references: [id])

  @@map("envios")
}

model EnvioItem {
  envioId            String   @map("envio_id")
  productoId         String   @map("producto_id")
  cantidadSolicitada Int      @map("cantidad_solicitada")
  cantidadEnviada    Int?     @map("cantidad_enviada")
  cantidadRecibida   Int?     @map("cantidad_recibida")
  envio              Envio    @relation(fields: [envioId], references: [id], onDelete: Cascade)
  producto           Producto @relation(fields: [productoId], references: [id])

  @@id([envioId, productoId])
  @@map("envio_items")
}

model Venta {
  id         String      @id @default(cuid())
  sucursalId String      @map("sucursal_id")
  vendedorId Int?        @map("usuario_id")
  totalVenta Decimal     @map("total_venta") @db.Decimal(12, 2)
  metodoPago String?     @map("metodo_pago")
  createdAt  DateTime    @default(now()) @map("creado_at")
  items      VentaItem[]
  sucursal   Sucursal    @relation(fields: [sucursalId], references: [id])
  vendedor   Usuario?    @relation(fields: [vendedorId], references: [id])

  @@map("ventas")
}

model VentaItem {
  id             Int      @id @default(autoincrement())
  ventaId        String   @map("venta_id")
  productoId     String   @map("producto_id")
  cantidad       Int
  precioUnitario Decimal  @map("precio_unitario") @db.Decimal(12, 2)
  producto       Producto @relation(fields: [productoId], references: [id])
  venta          Venta    @relation(fields: [ventaId], references: [id], onDelete: Cascade)

  @@map("venta_items")
}

model Notificacion {
  id        Int      @id @default(autoincrement())
  usuarioId Int      @map("usuario_id")
  mensaje   String
  leida     Boolean  @default(false)
  createdAt DateTime @default(now()) @map("creado_at")
  usuario   Usuario  @relation(fields: [usuarioId], references: [id])

  @@map("notificaciones")
}

model OperacionDiaria {
  id                 String   @id @default(cuid())
  sucursalId         String   @map("sucursal_id")
  fecha              DateTime @db.Date
  totalAVender       Decimal  @default(0) @map("total_a_vender") @db.Decimal(12, 2)
  totalVendido       Decimal  @default(0) @map("total_vendido") @db.Decimal(12, 2)
  totalCosto         Decimal  @default(0) @map("total_costo") @db.Decimal(12, 2)
  totalPerdidas      Decimal  @default(0) @map("total_perdidas") @db.Decimal(12, 2)
  efectivoReal       Decimal  @default(0) @map("efectivo_real") @db.Decimal(12, 2)
  productosRecibidos Json?    @map("productos_recibidos")
  productosSobrantes Json?    @map("productos_sobrantes")
  cerrado            Boolean  @default(false)
  createdAt          DateTime @default(now()) @map("creado_at")

  sucursal     Sucursal     @relation(fields: [sucursalId], references: [id], onDelete: Cascade)
  devoluciones Devolucion[]

  @@unique([sucursalId, fecha])
  @@map("operaciones_diarias")
}

model Devolucion {
  id            Int      @id @default(autoincrement())
  operacionId   String   @map("operacion_id")
  productoId    String   @map("producto_id")
  cantidad      Int
  motivo        String // "vencido", "dañado", "no_vendido"
  costoUnitario Decimal  @map("costo_unitario") @db.Decimal(12, 2)
  costoTotal    Decimal  @map("costo_total") @db.Decimal(12, 2)
  createdAt     DateTime @default(now()) @map("creado_at")

  operacion OperacionDiaria @relation(fields: [operacionId], references: [id], onDelete: Cascade)
  producto  Producto        @relation(fields: [productoId], references: [id])

  @@map("devoluciones")
}

model ProduccionDiaria {
  id                    String    @id @default(cuid())
  fecha                 DateTime  @default(now()) @db.Date
  productoId            String    @map("producto_id")
  cantidadContenedores  Int       @default(0) @map("cantidad_contenedores") // Ej: 100 latas
  unidadesPorContenedor Int       @default(1) @map("unidades_por_contenedor") // Ej: 24 panes por lata
  totalUnidades         Int       @default(0) @map("total_unidades") // 100 * 24 = 2400
  observaciones         String?
  registradoPor         Int       @map("registrado_por")
  turno                 String    @default("manana") // "manana" o "noche"
  enviado               Boolean   @default(false) // Si ya fue enviado a bodega
  firmadoPor            Int?      @map("firmado_por") // Usuario que firmó el envío
  fechaFirma            DateTime? @map("fecha_firma") // Cuándo se firmó
  confirmadoPor         Int?      @map("confirmado_por") // Usuario de bodega que confirmó
  fechaConfirmacion     DateTime? @map("fecha_confirmacion") // Cuándo se confirmó en bodega
  createdAt             DateTime  @default(now()) @map("creado_at")
  updatedAt             DateTime  @updatedAt @map("actualizado_at")

  producto Producto @relation(fields: [productoId], references: [id])

  @@unique([fecha, productoId, turno])
  @@map("produccion_diaria")
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  usuarioId Int?     @map("usuario_id")
  accion    String // "LOGIN", "LOGOUT", "CREATE_USER", "UPDATE_USER", "DELETE_USER", etc.
  entidad   String? // "Usuario", "Producto", "Venta", etc.
  entidadId String?  @map("entidad_id")
  detalles  Json? // Información adicional sobre la acción
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  exitoso   Boolean  @default(true)
  createdAt DateTime @default(now()) @map("creado_at")

  usuario Usuario? @relation(fields: [usuarioId], references: [id], onDelete: SetNull)

  @@index([usuarioId])
  @@index([accion])
  @@index([createdAt])
  @@map("audit_logs")
}

// Plantillas de producción diaria
model PlantillaProduccion {
  id          String  @id @default(cuid())
  nombre      String // "Lunes Panadería", "Martes Especial"
  diaSemana   Int     @map("dia_semana") // 1=Lunes, 2=Martes, ..., 7=Domingo
  descripcion String?
  activa      Boolean @default(true)
  color       String? // Color hex para UI

  items PlantillaProduccionItem[]

  createdAt DateTime @default(now()) @map("creado_at")
  updatedAt DateTime @updatedAt @map("actualizado_at")

  @@index([diaSemana])
  @@map("plantillas_produccion")
}

model PlantillaProduccionItem {
  id                    String @id @default(cuid())
  plantillaId           String @map("plantilla_id")
  productoId            String @map("producto_id")
  cantidadContenedores  Int    @map("cantidad_contenedores")
  unidadesPorContenedor Int    @map("unidades_por_contenedor")
  orden                 Int    @default(0) // Para ordenar en UI

  plantilla PlantillaProduccion @relation(fields: [plantillaId], references: [id], onDelete: Cascade)
  producto  Producto            @relation(fields: [productoId], references: [id])

  @@unique([plantillaId, productoId])
  @@map("plantilla_produccion_items")
}
